generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                   @id @default(uuid())
  role                Role
  email               String?                  @unique
  passwordHash        String
  createdAt           DateTime                 @default(now())
  phone               String?                  @unique
  reviewedEnrollments ClassEnrollmentRequest[]
  refreshTokens       RefreshToken[]
  studentProfile      StudentProfile?

  @@map("users")
}

model StudentProfile {
  id                   String                   @id @default(uuid())
  userId               String                   @unique
  studentCode          String                   @unique
  fullName             String
  avatarUrl            String?
  faceRegistered       Boolean                  @default(false)
  dateOfBirth          DateTime?
  identityCard         String?
  identityCardImage    String?
  attendances          Attendance[]
  enrollmentRequests   ClassEnrollmentRequest[]
  sessionRegistrations SessionRegistration[]
  user                 User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("student_profiles")
}

model TrainingClass {
  id                 String                   @id @default(uuid())
  code               String                   @unique
  name               String
  type               ClassType
  location           ClassLocation
  createdAt          DateTime                 @default(now())
  year               String                   @default("2025")
  latitude           Float?
  longitude          Float?
  enrollmentRequests ClassEnrollmentRequest[]
  sessions           ClassSession[]

  @@map("training_classes")
}

model ClassSession {
  id                   String                @id @default(uuid())
  date                 String
  name                 String
  startTime            String
  endTime              String
  registrationDeadline DateTime
  createdAt            DateTime              @default(now())
  isDeleted            Boolean               @default(false)
  trainingClassId      String?
  isAutoSelected       Boolean               @default(false)
  attendances          Attendance[]
  trainingClass        TrainingClass?        @relation(fields: [trainingClassId], references: [id], onDelete: Cascade)
  sessionRegistrations SessionRegistration[]

  @@map("class_sessions")
}

model SessionRegistration {
  id           String         @id @default(uuid())
  studentId    String
  sessionId    String
  registeredAt DateTime       @default(now())
  session      ClassSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student      StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, sessionId])
  @@map("session_registrations")
}

model Attendance {
  id                String           @id @default(uuid())
  studentId         String
  sessionId         String
  checkInTime       DateTime?
  checkInLat        Float?
  checkInLng        Float?
  checkInFaceScore  Float?
  checkOutTime      DateTime?
  checkOutLat       Float?
  checkOutLng       Float?
  checkOutFaceScore Float?
  status            AttendanceStatus @default(ABSENT)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  checkInImageUrl   String?
  checkOutImageUrl  String?
  locationNote      String?
  session           ClassSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student           StudentProfile   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, sessionId])
  @@map("attendances")
}

model ClassEnrollmentRequest {
  id              String                @id @default(uuid())
  studentId       String
  trainingClassId String
  status          ClassEnrollmentStatus @default(PENDING)
  requestedAt     DateTime              @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  reviewer        User?                 @relation(fields: [reviewedBy], references: [id])
  student         StudentProfile        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  trainingClass   TrainingClass         @relation(fields: [trainingClassId], references: [id], onDelete: Cascade)

  @@unique([studentId, trainingClassId])
  @@map("class_enrollment_requests")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

enum Role {
  ADMIN
  STUDENT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum ClassEnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ClassType {
  NAIL
  HAIR
  TATTOO
}

enum ClassLocation {
  CAN_THO
  HO_CHI_MINH
}
